DROP TABLE IF EXISTS USERS CASCADE;
DROP TABLE IF EXISTS CATEGORIES CASCADE;
DROP TABLE IF EXISTS LOCATIONS CASCADE;
DROP TABLE IF EXISTS EVENTS CASCADE;
DROP TABLE IF EXISTS REQUESTS CASCADE;
DROP TABLE IF EXISTS COMPILATIONS CASCADE;
DROP TABLE IF EXISTS COMPILATIONS_EVENTS CASCADE;


CREATE TABLE IF NOT EXISTS USERS
(
    ID    BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    NAME  VARCHAR(255)                            NOT NULL,
    EMAIL VARCHAR(255)                            NOT NULL UNIQUE,
    CONSTRAINT PK_USER
        PRIMARY KEY (ID)
);


CREATE TABLE IF NOT EXISTS CATEGORIES
(
    ID   BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    NAME VARCHAR(255)                            NOT NULL UNIQUE,
    CONSTRAINT PK_CATEGORY
        PRIMARY KEY (ID)
);



CREATE TABLE IF NOT EXISTS EVENTS
(
    ID                 BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    ANNOTATION         VARCHAR(500) NOT NULL,
    CATEGORY_ID        BIGINT NOT NULL,
    CONFIRMED_REQUESTS BIGINT NOT NULL,
    DESCRIPTION        TEXT NOT NULL,
    EVENT_DATE         TIMESTAMP WITHOUT TIME ZONE,
    CREATED_ON         TIMESTAMP WITHOUT TIME ZONE,
    INITIATOR_ID       BIGINT NOT NULL,
    location_lat       FLOAT NOT NULL,
    location_lon       FLOAT NOT NULL,
    PAID               BOOLEAN NOT NULL,
    PARTICIPANT_LIMIT  BIGINT DEFAULT(0),
    PUBLISHED_ON       TIMESTAMP WITHOUT TIME ZONE,
    REQUEST_MODERATION BOOLEAN NOT NULL,
    STATE              VARCHAR(120) NOT NULL,
    TITLE              VARCHAR(120) NOT NULL,
    VIEWS              BIGINT,
    CONSTRAINT PK_EVENT
        PRIMARY KEY (ID),
    CONSTRAINT EVENTS_CATEGORIES_ID_FK
        FOREIGN KEY (CATEGORY_ID)
            REFERENCES CATEGORIES (ID) ON DELETE CASCADE,

    CONSTRAINT EVENTS_USERS_ID_FK
        FOREIGN KEY (INITIATOR_ID)
            REFERENCES USERS (ID) ON DELETE CASCADE
);


CREATE TABLE IF NOT EXISTS REQUESTS
(
    ID        BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    CREATED   TIMESTAMP WITHOUT TIME ZONE,
    EVENT     BIGINT                                  NOT NULL,
    REQUESTER BIGINT                                  NOT NULL,
    STATUS    VARCHAR(120)                            NOT NULL,
    CONSTRAINT PK_REQUEST
        PRIMARY KEY (ID),
    CONSTRAINT REQUESTS_EVENTS_ID_FK
        FOREIGN KEY (EVENT)
            REFERENCES EVENTS (ID) ON DELETE CASCADE,
    CONSTRAINT REQUESTS_USERS_ID_FK
        FOREIGN KEY (REQUESTER)
            REFERENCES USERS (ID) ON DELETE CASCADE
);


CREATE TABLE IF NOT EXISTS COMPILATIONS
(
    ID     BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY NOT NULL,
    PINNED BOOLEAN NOT NULL,
    TITLE  VARCHAR(550),
    CONSTRAINT UQ_COMPILATION_TITLE UNIQUE (TITLE)
);

CREATE TABLE IF NOT EXISTS COMPILATIONS_EVENTS
(
    ID             BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY NOT NULL,
    EVENT_ID       BIGINT NOT NULL,
    COMPILATION_ID BIGINT NOT NULL,
    CONSTRAINT FK_TO_COMPILATIONS
        FOREIGN KEY (COMPILATION_ID) REFERENCES COMPILATIONS (ID),
    CONSTRAINT FK_TO_EVENTS
        FOREIGN KEY (EVENT_ID) REFERENCES EVENTS (ID)
);